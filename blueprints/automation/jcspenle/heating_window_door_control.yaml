blueprint:
  name: Heating Control - Window/Door/Skylight Detection v1.4.0 Universal
  source_url: https://raw.githubusercontent.com/jcspenle/HA_SensorPilotWire/main/blueprints/automation/jcspenle/heating_window_door_control_universal.yaml
  description: >
    ‚ö†Ô∏è VERSION 2.0.0 - BREAKING CHANGES - Les fen√™tres ont maintenant un d√©lai par d√©faut de 45s.
    
    Automated heating control with window/door/skylight sensors - Compatible Z-Wave & NodOn modules.
    
    **3 types de capteurs avec timers diff√©rents :**
    - Velux/Vasistas: timer configurable (d√©faut 0s = imm√©diat) pour a√©ration volontaire
    - Fen√™tres: timer configurable (d√©faut 45s) pour √©viter r√©actions au chat/volets
    - Portes: timer configurable (d√©faut 4min) pour ouvertures prolong√©es
    
    **Fonctionnalit√©s :**
    - Configurable modes when open/closed (comfort, comfort-1, comfort-2, eco, off)
    - Automation status selector (Activated / Bypass)
    - Module type selector: Z-Wave (climate) or NodOn (select fil pilote)
    - At least one sensor type required (skylight OR window OR door)
    - Support for inverted sensor logic (on=closed / off=open)
    - Notifications in French when heating state changes
    - Activity logging with room names
    - Smart mode: restores previous preset when closing
    - Dashboard sensors for each sensor type status
    
    **‚ö†Ô∏è MIGRATION depuis v1.x :**
    Les capteurs dans "window_sensors" ont maintenant un d√©lai de 45s par d√©faut.
    Si vous voulez le comportement imm√©diat pr√©c√©dent, mettez le d√©lai √† 0s ou utilisez "skylight_sensors".
  domain: automation

  input:
    automation_status:
      name: Statut de l'automation
      description: Choisir 'Active' pour activer la logique ou 'Bypass' pour la d√©sactiver.
      selector:
        select:
          options: ["Active","Bypass"]
      default: "Active"

    module_type:
      name: Type de module chauffage
      description: "Z-Wave: utilise climate entity | NodOn: utilise select fil pilote entity"
      selector:
        select:
          options: ["Z-Wave", "NodOn"]
      default: "Z-Wave"

    heating_entity_climate:
      name: Entit√© de chauffage (Z-Wave)
      description: "S√©lectionner l'entit√© climate pour les modules Z-Wave"
      selector:
        entity:
          domain: climate
      default: ""

    heating_entity_select:
      name: Entit√© de chauffage (NodOn)
      description: "S√©lectionner l'entit√© select fil pilote pour les modules NodOn"
      selector:
        entity:
          domain: select
      default: ""

    skylight_sensors:
      name: Capteurs de velux/vasistas (optionnel)
      description: S√©lectionner les capteurs de velux pour cette pi√®ce (a√©ration volontaire, timer court). Laisser vide si aucun.
      selector:
        entity:
          domain: binary_sensor
          device_class: window
          multiple: true
      default: []

    skylight_open_delay:
      name: D√©lai d'ouverture velux
      description: Temps minimum d'ouverture continue avant action pour les VELUX (d√©faut 0s = imm√©diat).
      selector:
        duration: {}
      default:
        hours: 0
        minutes: 0
        seconds: 0

    window_sensors:
      name: Capteurs de fen√™tres (optionnel)
      description: ‚ö†Ô∏è v2.0 - S√©lectionner les capteurs de fen√™tre (action apr√®s d√©lai pour √©viter chat/volets). Laisser vide si aucun.
      selector:
        entity:
          domain: binary_sensor
          device_class: window
          multiple: true
      default: []

    window_open_delay:
      name: D√©lai d'ouverture fen√™tre
      description: Temps minimum d'ouverture continue avant action pour les FEN√äTRES (d√©faut 45s).
      selector:
        duration: {}
      default:
        hours: 0
        minutes: 0
        seconds: 45

    door_sensors:
      name: Capteurs de portes (optionnel)
      description: S√©lectionner les capteurs de porte pour cette pi√®ce (d√©lai prolong√©). Laisser vide si aucun.
      selector:
        entity:
          domain: binary_sensor
          device_class: door
          multiple: true
      default: []

    door_open_delay:
      name: D√©lai d'ouverture porte
      description: Temps minimum d'ouverture continue avant action pour les PORTES (d√©faut 4min).
      selector:
        duration: {}
      default:
        hours: 0
        minutes: 4
        seconds: 0

    sensor_logic:
      name: Logique des capteurs
      description: "Normal: on=ouvert, off=ferm√© | Inverse: on=ferm√©, off=ouvert"
      selector:
        select:
          options: ["Normal","Inverse"]
      default: "Normal"

    min_closed_duration:
      name: Dur√©e minimale de fermeture
      description: Attendre ce d√©lai avant de restaurer le chauffage (√©vite les changements rapides). S'applique √† tous les types.
      selector:
        duration: {}
      default:
        hours: 0
        minutes: 2
        seconds: 0

    mode_when_open:
      name: Mode quand ouvert
      description: Preset du climate quand un capteur est ouvert (apr√®s d√©lai selon type).
      selector:
        select:
          options: ["comfort","comfort-1","comfort-2","eco","off"]
      default: "off"

    mode_when_closed:
      name: Mode quand ferm√©
      description: Preset du climate quand TOUS les capteurs sont ferm√©s (mode de restauration).
      selector:
        select:
          options: ["comfort","comfort-1","comfort-2","eco","off"]
      default: "comfort"

    smart_restore:
      name: Restauration intelligente
      description: M√©moriser et restaurer le mode pr√©c√©dent au lieu d'utiliser le mode par d√©faut.
      selector:
        boolean: {}
      default: false

    room_name:
      name: Nom de la pi√®ce
      description: Nom de la pi√®ce pour les notifications et logs (ex. "Salon", "Chambre").
      selector:
        text: {}
      default: "Pi√®ce"

    notify_devices:
      name: Appareils √† notifier (optionnel)
      description: S√©lectionner un ou plusieurs appareils mobiles pour recevoir les notifications. Laisser vide pour d√©sactiver.
      selector:
        device:
          integration: mobile_app
          multiple: true
      default: []

    log_entity:
      name: Entit√© de log (optionnel)
      description: input_text pour logger l'activit√© (cr√©er un helper input_text si besoin). Laisser vide pour d√©sactiver.
      selector:
        entity:
          domain: input_text
      default: ""

    skylight_status_sensor:
      name: Capteur d'√©tat velux (optionnel)
      description: input_text pour afficher l'√©tat des velux dans le dashboard. Laisser vide pour d√©sactiver.
      selector:
        entity:
          domain: input_text
      default: ""

    window_status_sensor:
      name: Capteur d'√©tat fen√™tres (optionnel)
      description: input_text pour afficher l'√©tat des fen√™tres dans le dashboard. Laisser vide pour d√©sactiver.
      selector:
        entity:
          domain: input_text
      default: ""

    door_status_sensor:
      name: Capteur d'√©tat portes (optionnel)
      description: input_text pour afficher l'√©tat des portes dans le dashboard. Laisser vide pour d√©sactiver.
      selector:
        entity:
          domain: input_text
      default: ""

# ===== Variables =====
variables:
  status: !input automation_status
  module_type: !input module_type
  heating_entity_climate: !input heating_entity_climate
  heating_entity_select: !input heating_entity_select
  heating_entity: >
    {{ heating_entity_climate if module_type == 'Z-Wave' else heating_entity_select }}
  open_mode: !input mode_when_open
  closed_mode: !input mode_when_closed
  skylights: !input skylight_sensors
  windows: !input window_sensors
  doors: !input door_sensors
  skylight_delay: !input skylight_open_delay
  window_delay: !input window_open_delay
  door_delay: !input door_open_delay
  min_close_delay: !input min_closed_duration
  logic: !input sensor_logic
  smart_mode: !input smart_restore
  room: !input room_name
  notify_devs: !input notify_devices
  log_ent: !input log_entity
  skylight_sensor: !input skylight_status_sensor
  window_sensor: !input window_status_sensor
  door_sensor: !input door_status_sensor
  all_sensors: >
    {{ (skylights | default([])) + (windows | default([])) + (doors | default([])) }}
  has_skylights: >
    {{ (skylights | default([]) | length) > 0 }}
  has_windows: >
    {{ (windows | default([]) | length) > 0 }}
  has_doors: >
    {{ (doors | default([]) | length) > 0 }}
  state_open: >
    {{ 'off' if logic == 'Inverse' else 'on' }}
  state_closed: >
    {{ 'on' if logic == 'Inverse' else 'off' }}
  current_preset: >
    {% if module_type == 'NodOn' %}
      {{ states(heating_entity) }}
    {% else %}
      {{ state_attr(heating_entity, 'preset_mode') }}
    {% endif %}
  # Mapper les modes pour NodOn (comfort-1 ‚Üí comfort_-1)
  open_mode_mapped: >
    {% set mode = open_mode %}
    {{ 'comfort_-1' if mode == 'comfort-1' else 
       'comfort_-2' if mode == 'comfort-2' else mode }}
  closed_mode_mapped: >
    {% set mode = closed_mode %}
    {{ 'comfort_-1' if mode == 'comfort-1' else 
       'comfort_-2' if mode == 'comfort-2' else mode }}

# ===== Triggers =====
trigger:
  # === SKYLIGHTS ===
  # Template trigger for skylights opened
  - platform: template
    value_template: >
      {% set skylight_list = skylights | default([]) %}
      {% set open_state = 'off' if logic == 'Inverse' else 'on' %}
      {{ skylight_list | length > 0 and 
         expand(skylight_list) | selectattr('state','eq', open_state) | list | length > 0 }}
    id: skylight_opened

  # Template trigger for skylights closed
  - platform: template
    value_template: >
      {% set skylight_list = skylights | default([]) %}
      {% set closed_state = 'on' if logic == 'Inverse' else 'off' %}
      {{ skylight_list | length > 0 and 
         expand(skylight_list) | selectattr('state','eq', closed_state) | list | length > 0 }}
    id: skylight_closed

  # === WINDOWS ===
  # Template trigger for windows opened
  - platform: template
    value_template: >
      {% set window_list = windows | default([]) %}
      {% set open_state = 'off' if logic == 'Inverse' else 'on' %}
      {{ window_list | length > 0 and 
         expand(window_list) | selectattr('state','eq', open_state) | list | length > 0 }}
    id: window_opened

  # Template trigger for windows closed
  - platform: template
    value_template: >
      {% set window_list = windows | default([]) %}
      {% set closed_state = 'on' if logic == 'Inverse' else 'off' %}
      {{ window_list | length > 0 and 
         expand(window_list) | selectattr('state','eq', closed_state) | list | length > 0 }}
    id: window_closed

  # === DOORS ===
  # Template trigger for doors opened
  - platform: template
    value_template: >
      {% set door_list = doors | default([]) %}
      {% set open_state = 'off' if logic == 'Inverse' else 'on' %}
      {{ door_list | length > 0 and 
         expand(door_list) | selectattr('state','eq', open_state) | list | length > 0 }}
    id: door_opened

  # Template trigger for doors closed
  - platform: template
    value_template: >
      {% set door_list = doors | default([]) %}
      {% set closed_state = 'on' if logic == 'Inverse' else 'off' %}
      {{ door_list | length > 0 and 
         expand(door_list) | selectattr('state','eq', closed_state) | list | length > 0 }}
    id: door_closed

# ===== Conditions =====
condition:
  # Must be activated via status
  - condition: template
    value_template: "{{ status == 'Active' }}"
  # Require at least one sensor (skylight OR window OR door)
  - condition: template
    value_template: "{{ (skylights | default([])) | length > 0 or (windows | default([])) | length > 0 or (doors | default([])) | length > 0 }}"

# ===== Actions =====
action:
  - choose:
      # ============================================================
      # === SKYLIGHT OPENED (with delay) ===
      # ============================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'skylight_opened' }}"
        sequence:
          # Wait configured delay (d√©faut 0s = imm√©diat)
          - delay: !input skylight_open_delay
          # Verify at least one skylight is still open
          - condition: template
            value_template: >
              {{ expand(skylights) | selectattr('state','eq', state_open) | list | length > 0 }}
          
          # Update skylight status sensor
          - if:
              - condition: template
                value_template: "{{ skylight_sensor != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ skylight_sensor }}"
                data:
                  value: >
                    {{ expand(skylights) | selectattr('state','eq', state_open) | list | length }} velux ouvert(s)
          
          # Apply OPEN mode according to module type
          - choose:
              # MODULE NODON
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'NodOn' }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      option: "{{ open_mode_mapped }}"
            # MODULE Z-WAVE
            default:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ open_mode == 'off' }}"
                    sequence:
                      - service: climate.turn_off
                        target:
                          entity_id: "{{ heating_entity }}"
                default:
                  - service: climate.set_preset_mode
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      preset_mode: "{{ open_mode }}"
          
          # Log action
          - if:
              - condition: template
                value_template: "{{ log_ent != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ log_ent }}"
                data:
                  value: >
                    {{ now().strftime('%H:%M') }} - {{ room }}: Velux ouvert{% if (skylight_delay.seconds | default(0)) > 0 or (skylight_delay.minutes | default(0)) > 0 %} (>{{ skylight_delay.minutes | default(0) }}min {{ skylight_delay.seconds | default(0) }}s){% endif %} - Chauffage {{ '√âTEINT' if open_mode == 'off' else 'mode ' + open_mode }}
          
          # Send notification
          - if:
              - condition: template
                value_template: "{{ notify_devs | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notify_devs }}"
                  sequence:
                    - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                      data:
                        message: >
                          ü™ü {{ room }}: Velux ouvert - Chauffage {{ '√©teint' if open_mode == 'off' else 'r√©duit (' + open_mode + ')' }}
                        title: "Chauffage d√©sactiv√©"

      # ============================================================
      # === SKYLIGHT CLOSED ===
      # ============================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'skylight_closed' }}"
        sequence:
          # Wait minimum closed duration
          - delay: !input min_closed_duration
          # Verify ALL sensors are now closed
          - condition: template
            value_template: >
              {{ expand(all_sensors) | selectattr('state','eq', state_open) | list | length == 0 }}
          
          # Update skylight status sensor
          - if:
              - condition: template
                value_template: "{{ skylight_sensor != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ skylight_sensor }}"
                data:
                  value: "Tous les velux ferm√©s"
          
          # Determine mode to restore
          - variables:
              restore_mode: >
                {% if smart_mode and current_preset != none and current_preset != 'none' %}
                  {{ current_preset }}
                {% else %}
                  {{ closed_mode if module_type == 'Z-Wave' else closed_mode_mapped }}
                {% endif %}
          
          # Apply restore mode according to module type
          - choose:
              # MODULE NODON
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'NodOn' }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      option: "{{ restore_mode }}"
            # MODULE Z-WAVE
            default:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ restore_mode == 'off' }}"
                    sequence:
                      - service: climate.turn_off
                        target:
                          entity_id: "{{ heating_entity }}"
                default:
                  - service: climate.turn_on
                    target:
                      entity_id: "{{ heating_entity }}"
                  - service: climate.set_preset_mode
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      preset_mode: "{{ restore_mode }}"
          
          # Log action
          - if:
              - condition: template
                value_template: "{{ log_ent != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ log_ent }}"
                data:
                  value: >
                    {{ now().strftime('%H:%M') }} - {{ room }}: Tout ferm√© - Chauffage {{ 'ALLUM√â' if restore_mode != 'off' else '√âTEINT' }} ({{ restore_mode }})
          
          # Send notification
          - if:
              - condition: template
                value_template: "{{ notify_devs | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notify_devs }}"
                  sequence:
                    - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                      data:
                        message: >
                          ‚úÖ {{ room }}: Tout ferm√© - Chauffage {{ 'rallum√©' if restore_mode != 'off' else '√©teint' }} ({{ restore_mode }})
                        title: "Chauffage restaur√©"

      # ============================================================
      # === WINDOW OPENED (with delay) ===
      # ============================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'window_opened' }}"
        sequence:
          # Wait configured delay (d√©faut 45s)
          - delay: !input window_open_delay
          # Verify at least one window is still open
          - condition: template
            value_template: >
              {{ expand(windows) | selectattr('state','eq', state_open) | list | length > 0 }}
          
          # Update window status sensor
          - if:
              - condition: template
                value_template: "{{ window_sensor != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ window_sensor }}"
                data:
                  value: >
                    {{ expand(windows) | selectattr('state','eq', state_open) | list | length }} fen√™tre(s) ouverte(s)
          
          # Apply OPEN mode according to module type
          - choose:
              # MODULE NODON
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'NodOn' }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      option: "{{ open_mode_mapped }}"
            # MODULE Z-WAVE
            default:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ open_mode == 'off' }}"
                    sequence:
                      - service: climate.turn_off
                        target:
                          entity_id: "{{ heating_entity }}"
                default:
                  - service: climate.set_preset_mode
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      preset_mode: "{{ open_mode }}"
          
          # Log action
          - if:
              - condition: template
                value_template: "{{ log_ent != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ log_ent }}"
                data:
                  value: >
                    {{ now().strftime('%H:%M') }} - {{ room }}: Fen√™tre ouverte (>{{ window_delay.minutes | default(0) }}min {{ window_delay.seconds | default(45) }}s) - Chauffage {{ '√âTEINT' if open_mode == 'off' else 'mode ' + open_mode }}
          
          # Send notification
          - if:
              - condition: template
                value_template: "{{ notify_devs | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notify_devs }}"
                  sequence:
                    - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                      data:
                        message: >
                          ü™ü {{ room }}: Fen√™tre ouverte - Chauffage {{ '√©teint' if open_mode == 'off' else 'r√©duit (' + open_mode + ')' }}
                        title: "Chauffage d√©sactiv√©"

      # ============================================================
      # === WINDOW CLOSED ===
      # ============================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'window_closed' }}"
        sequence:
          # Wait minimum closed duration
          - delay: !input min_closed_duration
          # Verify ALL sensors are now closed
          - condition: template
            value_template: >
              {{ expand(all_sensors) | selectattr('state','eq', state_open) | list | length == 0 }}
          
          # Update window status sensor
          - if:
              - condition: template
                value_template: "{{ window_sensor != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ window_sensor }}"
                data:
                  value: "Toutes les fen√™tres ferm√©es"
          
          # Determine mode to restore
          - variables:
              restore_mode: >
                {% if smart_mode and current_preset != none and current_preset != 'none' %}
                  {{ current_preset }}
                {% else %}
                  {{ closed_mode if module_type == 'Z-Wave' else closed_mode_mapped }}
                {% endif %}
          
          # Apply restore mode according to module type
          - choose:
              # MODULE NODON
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'NodOn' }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      option: "{{ restore_mode }}"
            # MODULE Z-WAVE
            default:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ restore_mode == 'off' }}"
                    sequence:
                      - service: climate.turn_off
                        target:
                          entity_id: "{{ heating_entity }}"
                default:
                  - service: climate.turn_on
                    target:
                      entity_id: "{{ heating_entity }}"
                  - service: climate.set_preset_mode
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      preset_mode: "{{ restore_mode }}"
          
          # Log action
          - if:
              - condition: template
                value_template: "{{ log_ent != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ log_ent }}"
                data:
                  value: >
                    {{ now().strftime('%H:%M') }} - {{ room }}: Tout ferm√© - Chauffage {{ 'ALLUM√â' if restore_mode != 'off' else '√âTEINT' }} ({{ restore_mode }})
          
          # Send notification
          - if:
              - condition: template
                value_template: "{{ notify_devs | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notify_devs }}"
                  sequence:
                    - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                      data:
                        message: >
                          ‚úÖ {{ room }}: Tout ferm√© - Chauffage {{ 'rallum√©' if restore_mode != 'off' else '√©teint' }} ({{ restore_mode }})
                        title: "Chauffage restaur√©"

      # ============================================================
      # === DOOR OPENED (with delay) ===
      # ============================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'door_opened' }}"
        sequence:
          # Wait configured delay (d√©faut 4min)
          - delay: !input door_open_delay
          # Verify at least one door is still open
          - condition: template
            value_template: >
              {{ expand(doors) | selectattr('state','eq', state_open) | list | length > 0 }}
          
          # Update door status sensor
          - if:
              - condition: template
                value_template: "{{ door_sensor != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ door_sensor }}"
                data:
                  value: >
                    {{ expand(doors) | selectattr('state','eq', state_open) | list | length }} porte(s) ouverte(s)
          
          # Apply OPEN mode according to module type
          - choose:
              # MODULE NODON
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'NodOn' }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      option: "{{ open_mode_mapped }}"
            # MODULE Z-WAVE
            default:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ open_mode == 'off' }}"
                    sequence:
                      - service: climate.turn_off
                        target:
                          entity_id: "{{ heating_entity }}"
                default:
                  - service: climate.set_preset_mode
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      preset_mode: "{{ open_mode }}"
          
          # Log action
          - if:
              - condition: template
                value_template: "{{ log_ent != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ log_ent }}"
                data:
                  value: >
                    {{ now().strftime('%H:%M') }} - {{ room }}: Porte ouverte (>{{ door_delay.minutes | default(4) }}min) - Chauffage {{ '√âTEINT' if open_mode == 'off' else 'mode ' + open_mode }}
          
          # Send notification
          - if:
              - condition: template
                value_template: "{{ notify_devs | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notify_devs }}"
                  sequence:
                    - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                      data:
                        message: >
                          üö™ {{ room }}: Porte ouverte - Chauffage {{ '√©teint' if open_mode == 'off' else 'r√©duit (' + open_mode + ')' }}
                        title: "Chauffage d√©sactiv√©"

      # ============================================================
      # === DOOR CLOSED ===
      # ============================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'door_closed' }}"
        sequence:
          # Wait minimum closed duration
          - delay: !input min_closed_duration
          # Verify ALL sensors are now closed
          - condition: template
            value_template: >
              {{ expand(all_sensors) | selectattr('state','eq', state_open) | list | length == 0 }}
          
          # Update door status sensor
          - if:
              - condition: template
                value_template: "{{ door_sensor != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ door_sensor }}"
                data:
                  value: "Toutes les portes ferm√©es"
          
          # Determine mode to restore
          - variables:
              restore_mode: >
                {% if smart_mode and current_preset != none and current_preset != 'none' %}
                  {{ current_preset }}
                {% else %}
                  {{ closed_mode if module_type == 'Z-Wave' else closed_mode_mapped }}
                {% endif %}
          
          # Apply restore mode according to module type
          - choose:
              # MODULE NODON
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'NodOn' }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      option: "{{ restore_mode }}"
            # MODULE Z-WAVE
            default:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ restore_mode == 'off' }}"
                    sequence:
                      - service: climate.turn_off
                        target:
                          entity_id: "{{ heating_entity }}"
                default:
                  - service: climate.turn_on
                    target:
                      entity_id: "{{ heating_entity }}"
                  - service: climate.set_preset_mode
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      preset_mode: "{{ restore_mode }}"
          
          # Log action
          - if:
              - condition: template
                value_template: "{{ log_ent != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ log_ent }}"
                data:
                  value: >
                    {{ now().strftime('%H:%M') }} - {{ room }}: Tout ferm√© - Chauffage {{ 'ALLUM√â' if restore_mode != 'off' else '√âTEINT' }} ({{ restore_mode }})
          
          # Send notification
          - if:
              - condition: template
                value_template: "{{ notify_devs | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notify_devs }}"
                  sequence:
                    - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                      data:
                        message: >
                          ‚úÖ {{ room }}: Tout ferm√© - Chauffage {{ 'rallum√©' if restore_mode != 'off' else '√©teint' }} ({{ restore_mode }})
                        title: "Chauffage restaur√©"
    default: []

mode: single
