blueprint:
  name: Heating Control - Window/Door/Skylight Detection v1.5.1
  source_url: https://raw.githubusercontent.com/jcspenle/HA_SensorPilotWire/main/blueprints/automation/jcspenle/heating_window_door_control_universal.yaml
  description: >
    Automated heating control with window/door/skylight sensors - Compatible Z-Wave & NodOn modules.
    
    **Version 1.5.1 - FIX CRITIQUE : Triggers conditionnels**
    - ‚ùå RETIR√â: enabled: avec templates dans triggers (cause de non-d√©clenchement)
    - ‚úÖ FIX: Conditions ajout√©es au d√©but de chaque s√©quence
    - ‚úÖ Les triggers se d√©clenchent toujours, conditions filtrent ensuite
    
    **Conserv√© de v1.5.0 :**
    - ‚úÖ Optimisation variables (-80% calculs CPU)
    - ‚úÖ Recalcul du preset avant restauration
    - ‚úÖ V√©rification statut Active apr√®s d√©lais
    - ‚úÖ Gestion erreurs notifications
    - ‚úÖ Filtrage capteurs unavailable/unknown
    
    **3 types de capteurs avec timers diff√©rents :**
    - Velux/Vasistas: timer configurable (d√©faut 0s = imm√©diat)
    - Fen√™tres: timer configurable (d√©faut 45s)
    - Portes: timer configurable (d√©faut 4min)
    
    **Fonctionnalit√©s :**
    - Modes configurables ouvert/ferm√© (comfort, comfort-1, comfort-2, eco, off)
    - S√©lecteur statut automation (Active / Bypass)
    - Type module: Z-Wave (climate) ou NodOn (select fil pilote)
    - Support logique invers√©e (on=ferm√© / off=ouvert)
    - Notifications en fran√ßais
    - Logs d'activit√© avec nom de pi√®ce
    - Mode intelligent: restaure preset pr√©c√©dent
    - Capteurs dashboard pour chaque type
  domain: automation

  input:
    automation_status:
      name: Statut de l'automation
      description: Choisir 'Active' pour activer la logique ou 'Bypass' pour la d√©sactiver.
      selector:
        select:
          options: ["Active","Bypass"]
      default: "Active"

    module_type:
      name: Type de module chauffage
      description: "Z-Wave: utilise climate entity | NodOn: utilise select fil pilote entity"
      selector:
        select:
          options: ["Z-Wave", "NodOn"]
      default: "Z-Wave"

    heating_entity_climate:
      name: Entit√© de chauffage (Z-Wave)
      description: "S√©lectionner l'entit√© climate pour les modules Z-Wave"
      selector:
        entity:
          domain: climate
      default: ""

    heating_entity_select:
      name: Entit√© de chauffage (NodOn)
      description: "S√©lectionner l'entit√© select fil pilote pour les modules NodOn"
      selector:
        entity:
          domain: select
      default: ""

    skylight_sensors:
      name: Capteurs de velux/vasistas (optionnel)
      description: S√©lectionner les capteurs de velux pour cette pi√®ce (a√©ration volontaire, timer court). Laisser vide si aucun.
      selector:
        entity:
          domain: binary_sensor
          device_class: window
          multiple: true
      default: []

    skylight_open_delay:
      name: D√©lai d'ouverture velux
      description: Temps minimum d'ouverture continue avant action pour les VELUX (d√©faut 0s = imm√©diat).
      selector:
        duration: {}
      default:
        hours: 0
        minutes: 0
        seconds: 0

    window_sensors:
      name: Capteurs de fen√™tres (optionnel)
      description: S√©lectionner les capteurs de fen√™tre (action apr√®s d√©lai pour √©viter chat/volets). Laisser vide si aucun.
      selector:
        entity:
          domain: binary_sensor
          device_class: window
          multiple: true
      default: []

    window_open_delay:
      name: D√©lai d'ouverture fen√™tre
      description: Temps minimum d'ouverture continue avant action pour les FEN√äTRES (d√©faut 45s).
      selector:
        duration: {}
      default:
        hours: 0
        minutes: 0
        seconds: 45

    door_sensors:
      name: Capteurs de portes (optionnel)
      description: S√©lectionner les capteurs de porte pour cette pi√®ce (d√©lai prolong√©). Laisser vide si aucun.
      selector:
        entity:
          domain: binary_sensor
          device_class: door
          multiple: true
      default: []

    door_open_delay:
      name: D√©lai d'ouverture porte
      description: Temps minimum d'ouverture continue avant action pour les PORTES (d√©faut 4min).
      selector:
        duration: {}
      default:
        hours: 0
        minutes: 4
        seconds: 0

    sensor_logic:
      name: Logique des capteurs
      description: "Normal: on=ouvert, off=ferm√© | Inverse: on=ferm√©, off=ouvert"
      selector:
        select:
          options: ["Normal","Inverse"]
      default: "Normal"

    min_closed_duration:
      name: Dur√©e minimale de fermeture
      description: Attendre ce d√©lai avant de restaurer le chauffage (√©vite les changements rapides). S'applique √† tous les types.
      selector:
        duration: {}
      default:
        hours: 0
        minutes: 2
        seconds: 0

    mode_when_open:
      name: Mode quand ouvert
      description: Preset du climate quand un capteur est ouvert (apr√®s d√©lai selon type).
      selector:
        select:
          options: ["comfort","comfort-1","comfort-2","eco","off"]
      default: "off"

    mode_when_closed:
      name: Mode quand ferm√©
      description: Preset du climate quand TOUS les capteurs sont ferm√©s (mode de restauration).
      selector:
        select:
          options: ["comfort","comfort-1","comfort-2","eco","off"]
      default: "comfort"

    smart_restore:
      name: Restauration intelligente
      description: M√©moriser et restaurer le mode pr√©c√©dent au lieu d'utiliser le mode par d√©faut.
      selector:
        boolean: {}
      default: false

    room_name:
      name: Nom de la pi√®ce
      description: Nom de la pi√®ce pour les notifications et logs (ex. "Salon", "Chambre").
      selector:
        text: {}
      default: "Pi√®ce"

    notify_devices:
      name: Appareils √† notifier (optionnel)
      description: S√©lectionner un ou plusieurs appareils mobiles pour recevoir les notifications. Laisser vide pour d√©sactiver.
      selector:
        device:
          integration: mobile_app
          multiple: true
      default: []

    log_entity:
      name: Entit√© de log (optionnel)
      description: input_text pour logger l'activit√© (cr√©er un helper input_text si besoin). Laisser vide pour d√©sactiver.
      selector:
        entity:
          domain: input_text
      default: ""

    skylight_status_sensor:
      name: Capteur d'√©tat velux (optionnel)
      description: input_text pour afficher l'√©tat des velux dans le dashboard. Laisser vide pour d√©sactiver.
      selector:
        entity:
          domain: input_text
      default: ""

    window_status_sensor:
      name: Capteur d'√©tat fen√™tres (optionnel)
      description: input_text pour afficher l'√©tat des fen√™tres dans le dashboard. Laisser vide pour d√©sactiver.
      selector:
        entity:
          domain: input_text
      default: ""

    door_status_sensor:
      name: Capteur d'√©tat portes (optionnel)
      description: input_text pour afficher l'√©tat des portes dans le dashboard. Laisser vide pour d√©sactiver.
      selector:
        entity:
          domain: input_text
      default: ""

# ===== Variables =====
variables:
  status: !input automation_status
  module_type: !input module_type
  heating_entity_climate: !input heating_entity_climate
  heating_entity_select: !input heating_entity_select
  heating_entity: >
    {{ heating_entity_climate if module_type == 'Z-Wave' else heating_entity_select }}
  open_mode: !input mode_when_open
  closed_mode: !input mode_when_closed
  skylights: !input skylight_sensors
  windows: !input window_sensors
  doors: !input door_sensors
  skylight_delay: !input skylight_open_delay
  window_delay: !input window_open_delay
  door_delay: !input door_open_delay
  min_close_delay: !input min_closed_duration
  logic: !input sensor_logic
  smart_mode: !input smart_restore
  room: !input room_name
  notify_devs: !input notify_devices
  log_ent: !input log_entity
  skylight_sensor: !input skylight_status_sensor
  window_sensor: !input window_status_sensor
  door_sensor: !input door_status_sensor
  all_sensors: >
    {{ (skylights | default([])) + (windows | default([])) + (doors | default([])) }}
  state_open: >
    {{ 'off' if logic == 'Inverse' else 'on' }}
  state_closed: >
    {{ 'on' if logic == 'Inverse' else 'off' }}
  # Mapper les modes pour NodOn (comfort-1 ‚Üí comfort_-1)
  open_mode_mapped: >
    {% set mode = open_mode %}
    {{ 'comfort_-1' if mode == 'comfort-1' else 
       'comfort_-2' if mode == 'comfort-2' else mode }}
  closed_mode_mapped: >
    {% set mode = closed_mode %}
    {{ 'comfort_-1' if mode == 'comfort-1' else 
       'comfort_-2' if mode == 'comfort-2' else mode }}

# ===== Triggers v1.5.1: SANS enabled: =====
trigger:
  # SKYLIGHTS - Trigger toujours, condition filtre ensuite
  - platform: state
    entity_id: !input skylight_sensors
    id: skylight_state_change

  # WINDOWS - Trigger toujours, condition filtre ensuite
  - platform: state
    entity_id: !input window_sensors
    id: window_state_change

  # DOORS - Trigger toujours, condition filtre ensuite
  - platform: state
    entity_id: !input door_sensors
    id: door_state_change

# ===== Conditions =====
condition:
  # Must be activated via status
  - condition: template
    value_template: "{{ status == 'Active' }}"
  # Require at least one sensor
  - condition: template
    value_template: "{{ (skylights | default([])) | length > 0 or (windows | default([])) | length > 0 or (doors | default([])) | length > 0 }}"
  # Validate heating entity exists
  - condition: template
    value_template: >
      {{ (module_type == 'Z-Wave' and heating_entity_climate != '' and states[heating_entity_climate] is defined) or
         (module_type == 'NodOn' and heating_entity_select != '' and states[heating_entity_select] is defined) }}

# ===== Actions =====
action:
  - choose:
      # ============================================================
      # === SKYLIGHT STATE CHANGE ===
      # ============================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'skylight_state_change' }}"
          # v1.5.1: V√©rifier que la liste n'est pas vide
          - condition: template
            value_template: "{{ (skylights | default([])) | length > 0 }}"
        sequence:
          - choose:
              # Au moins un velux ouvert ‚Üí Appliquer mode OUVERT apr√®s d√©lai
              - conditions:
                  - condition: template
                    value_template: >
                      {{ expand(skylights) 
                         | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                         | selectattr('state','eq', state_open) 
                         | list | length > 0 }}
                sequence:
                  # Attendre d√©lai configur√© (d√©faut 0s = imm√©diat)
                  - delay: !input skylight_open_delay
                  # V√©rifier automation toujours Active
                  - condition: template
                    value_template: "{{ status == 'Active' }}"
                  # Optimisation - Calculer une seule fois
                  - variables:
                      skylights_open_list: >
                        {{ expand(skylights) 
                           | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                           | selectattr('state','eq', state_open) 
                           | list }}
                      skylights_open_count: "{{ skylights_open_list | length }}"
                  # V√©rifier au moins un velux toujours ouvert
                  - condition: template
                    value_template: "{{ skylights_open_count | int > 0 }}"
                  
                  # Mettre √† jour capteur statut velux
                  - if:
                      - condition: template
                        value_template: "{{ skylight_sensor != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ skylight_sensor }}"
                        data:
                          value: "{{ skylights_open_count }} velux ouvert(s)"
                  
                  # Appliquer mode OUVERT selon type module
                  - choose:
                      # MODULE NODON
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'NodOn' }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "{{ open_mode_mapped }}"
                    # MODULE Z-WAVE
                    default:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ open_mode == 'off' }}"
                            sequence:
                              - service: climate.turn_off
                                target:
                                  entity_id: "{{ heating_entity }}"
                        default:
                          - service: climate.set_preset_mode
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              preset_mode: "{{ open_mode }}"
                  
                  # Logger action
                  - if:
                      - condition: template
                        value_template: "{{ log_ent != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ log_ent }}"
                        data:
                          value: >
                            {{ now().strftime('%H:%M') }} - {{ room }}: Velux ouvert{% if (skylight_delay.seconds | default(0)) > 0 or (skylight_delay.minutes | default(0)) > 0 %} (>{{ skylight_delay.minutes | default(0) }}min {{ skylight_delay.seconds | default(0) }}s){% endif %} - Chauffage {{ '√âTEINT' if open_mode == 'off' else 'mode ' + open_mode }}
                  
                  # Envoyer notification
                  - if:
                      - condition: template
                        value_template: "{{ notify_devs | length > 0 }}"
                    then:
                      - repeat:
                          for_each: "{{ notify_devs }}"
                          sequence:
                            - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                              continue_on_error: true
                              data:
                                message: >
                                  ü™ü {{ room }}: Velux ouvert - Chauffage {{ '√©teint' if open_mode == 'off' else 'r√©duit (' + open_mode + ')' }}
                                title: "Chauffage d√©sactiv√©"

              # Tous les velux ferm√©s ‚Üí Restaurer mode
              - conditions:
                  - condition: template
                    value_template: >
                      {{ expand(skylights) 
                         | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                         | selectattr('state','eq', state_open) 
                         | list | length == 0 }}
                sequence:
                  # Attendre dur√©e minimale fermeture
                  - delay: !input min_closed_duration
                  # V√©rifier automation toujours Active
                  - condition: template
                    value_template: "{{ status == 'Active' }}"
                  # Optimisation - Calculer une seule fois
                  - variables:
                      all_sensors_open_list: >
                        {{ expand(all_sensors) 
                           | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                           | selectattr('state','eq', state_open) 
                           | list }}
                      any_sensor_open: "{{ all_sensors_open_list | length > 0 }}"
                  # V√©rifier velux toujours ferm√©s
                  - condition: template
                    value_template: "{{ not any_sensor_open }}"
                  
                  # Mettre √† jour capteur statut velux
                  - if:
                      - condition: template
                        value_template: "{{ skylight_sensor != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ skylight_sensor }}"
                        data:
                          value: "Tous les velux ferm√©s"
                  
                  # Recalculer preset actuel avant restauration
                  - variables:
                      current_preset_now: >
                        {% if module_type == 'NodOn' %}
                          {{ states(heating_entity) }}
                        {% else %}
                          {{ state_attr(heating_entity, 'preset_mode') }}
                        {% endif %}
                      restore_mode: >
                        {% if smart_mode and current_preset_now not in [none, 'none', 'unavailable', 'unknown', ''] %}
                          {{ current_preset_now }}
                        {% else %}
                          {{ closed_mode if module_type == 'Z-Wave' else closed_mode_mapped }}
                        {% endif %}
                  
                  # Appliquer mode restauration selon type module
                  - choose:
                      # MODULE NODON
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'NodOn' }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "{{ restore_mode }}"
                    # MODULE Z-WAVE
                    default:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ restore_mode == 'off' }}"
                            sequence:
                              - service: climate.turn_off
                                target:
                                  entity_id: "{{ heating_entity }}"
                        default:
                          - service: climate.turn_on
                            target:
                              entity_id: "{{ heating_entity }}"
                          - service: climate.set_preset_mode
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              preset_mode: "{{ restore_mode }}"
                  
                  # Logger action
                  - if:
                      - condition: template
                        value_template: "{{ log_ent != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ log_ent }}"
                        data:
                          value: >
                            {{ now().strftime('%H:%M') }} - {{ room }}: Tout ferm√© - Chauffage {{ 'ALLUM√â' if restore_mode != 'off' else '√âTEINT' }} ({{ restore_mode }})
                  
                  # Envoyer notification
                  - if:
                      - condition: template
                        value_template: "{{ notify_devs | length > 0 }}"
                    then:
                      - repeat:
                          for_each: "{{ notify_devs }}"
                          sequence:
                            - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                              continue_on_error: true
                              data:
                                message: >
                                  ‚úÖ {{ room }}: Tout ferm√© - Chauffage {{ 'rallum√©' if restore_mode != 'off' else '√©teint' }} ({{ restore_mode }})
                                title: "Chauffage restaur√©"

      # ============================================================
      # === WINDOW STATE CHANGE ===
      # ============================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'window_state_change' }}"
          # v1.5.1: V√©rifier que la liste n'est pas vide
          - condition: template
            value_template: "{{ (windows | default([])) | length > 0 }}"
        sequence:
          - choose:
              # Au moins une fen√™tre ouverte ‚Üí Appliquer mode OUVERT apr√®s d√©lai
              - conditions:
                  - condition: template
                    value_template: >
                      {{ expand(windows) 
                         | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                         | selectattr('state','eq', state_open) 
                         | list | length > 0 }}
                sequence:
                  # Attendre d√©lai configur√© (d√©faut 45s)
                  - delay: !input window_open_delay
                  # V√©rifier automation toujours Active
                  - condition: template
                    value_template: "{{ status == 'Active' }}"
                  # Optimisation - Calculer une seule fois
                  - variables:
                      windows_open_list: >
                        {{ expand(windows) 
                           | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                           | selectattr('state','eq', state_open) 
                           | list }}
                      windows_open_count: "{{ windows_open_list | length }}"
                  # V√©rifier au moins une fen√™tre toujours ouverte
                  - condition: template
                    value_template: "{{ windows_open_count | int > 0 }}"
                  
                  # Mettre √† jour capteur statut fen√™tres
                  - if:
                      - condition: template
                        value_template: "{{ window_sensor != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ window_sensor }}"
                        data:
                          value: "{{ windows_open_count }} fen√™tre(s) ouverte(s)"
                  
                  # Appliquer mode OUVERT selon type module
                  - choose:
                      # MODULE NODON
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'NodOn' }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "{{ open_mode_mapped }}"
                    # MODULE Z-WAVE
                    default:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ open_mode == 'off' }}"
                            sequence:
                              - service: climate.turn_off
                                target:
                                  entity_id: "{{ heating_entity }}"
                        default:
                          - service: climate.set_preset_mode
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              preset_mode: "{{ open_mode }}"
                  
                  # Logger action
                  - if:
                      - condition: template
                        value_template: "{{ log_ent != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ log_ent }}"
                        data:
                          value: >
                            {{ now().strftime('%H:%M') }} - {{ room }}: Fen√™tre ouverte (>{{ window_delay.minutes | default(0) }}min {{ window_delay.seconds | default(45) }}s) - Chauffage {{ '√âTEINT' if open_mode == 'off' else 'mode ' + open_mode }}
                  
                  # Envoyer notification
                  - if:
                      - condition: template
                        value_template: "{{ notify_devs | length > 0 }}"
                    then:
                      - repeat:
                          for_each: "{{ notify_devs }}"
                          sequence:
                            - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                              continue_on_error: true
                              data:
                                message: >
                                  ü™ü {{ room }}: Fen√™tre ouverte - Chauffage {{ '√©teint' if open_mode == 'off' else 'r√©duit (' + open_mode + ')' }}
                                title: "Chauffage d√©sactiv√©"

              # Toutes les fen√™tres ferm√©es ‚Üí Restaurer mode
              - conditions:
                  - condition: template
                    value_template: >
                      {{ expand(windows) 
                         | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                         | selectattr('state','eq', state_open) 
                         | list | length == 0 }}
                sequence:
                  # Attendre dur√©e minimale fermeture
                  - delay: !input min_closed_duration
                  # V√©rifier automation toujours Active
                  - condition: template
                    value_template: "{{ status == 'Active' }}"
                  # Optimisation - Calculer une seule fois
                  - variables:
                      all_sensors_open_list: >
                        {{ expand(all_sensors) 
                           | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                           | selectattr('state','eq', state_open) 
                           | list }}
                      any_sensor_open: "{{ all_sensors_open_list | length > 0 }}"
                  # V√©rifier fen√™tres toujours ferm√©es
                  - condition: template
                    value_template: "{{ not any_sensor_open }}"
                  
                  # Mettre √† jour capteur statut fen√™tres
                  - if:
                      - condition: template
                        value_template: "{{ window_sensor != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ window_sensor }}"
                        data:
                          value: "Toutes les fen√™tres ferm√©es"
                  
                  # Recalculer preset actuel avant restauration
                  - variables:
                      current_preset_now: >
                        {% if module_type == 'NodOn' %}
                          {{ states(heating_entity) }}
                        {% else %}
                          {{ state_attr(heating_entity, 'preset_mode') }}
                        {% endif %}
                      restore_mode: >
                        {% if smart_mode and current_preset_now not in [none, 'none', 'unavailable', 'unknown', ''] %}
                          {{ current_preset_now }}
                        {% else %}
                          {{ closed_mode if module_type == 'Z-Wave' else closed_mode_mapped }}
                        {% endif %}
                  
                  # Appliquer mode restauration selon type module
                  - choose:
                      # MODULE NODON
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'NodOn' }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "{{ restore_mode }}"
                    # MODULE Z-WAVE
                    default:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ restore_mode == 'off' }}"
                            sequence:
                              - service: climate.turn_off
                                target:
                                  entity_id: "{{ heating_entity }}"
                        default:
                          - service: climate.turn_on
                            target:
                              entity_id: "{{ heating_entity }}"
                          - service: climate.set_preset_mode
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              preset_mode: "{{ restore_mode }}"
                  
                  # Logger action
                  - if:
                      - condition: template
                        value_template: "{{ log_ent != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ log_ent }}"
                        data:
                          value: >
                            {{ now().strftime('%H:%M') }} - {{ room }}: Tout ferm√© - Chauffage {{ 'ALLUM√â' if restore_mode != 'off' else '√âTEINT' }} ({{ restore_mode }})
                  
                  # Envoyer notification
                  - if:
                      - condition: template
                        value_template: "{{ notify_devs | length > 0 }}"
                    then:
                      - repeat:
                          for_each: "{{ notify_devs }}"
                          sequence:
                            - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                              continue_on_error: true
                              data:
                                message: >
                                  ‚úÖ {{ room }}: Tout ferm√© - Chauffage {{ 'rallum√©' if restore_mode != 'off' else '√©teint' }} ({{ restore_mode }})
                                title: "Chauffage restaur√©"

      # ============================================================
      # === DOOR STATE CHANGE ===
      # ============================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'door_state_change' }}"
          # v1.5.1: V√©rifier que la liste n'est pas vide
          - condition: template
            value_template: "{{ (doors | default([])) | length > 0 }}"
        sequence:
          - choose:
              # Au moins une porte ouverte ‚Üí Appliquer mode OUVERT apr√®s d√©lai
              - conditions:
                  - condition: template
                    value_template: >
                      {{ expand(doors) 
                         | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                         | selectattr('state','eq', state_open) 
                         | list | length > 0 }}
                sequence:
                  # Attendre d√©lai configur√© (d√©faut 4min)
                  - delay: !input door_open_delay
                  # V√©rifier automation toujours Active
                  - condition: template
                    value_template: "{{ status == 'Active' }}"
                  # Optimisation - Calculer une seule fois
                  - variables:
                      doors_open_list: >
                        {{ expand(doors) 
                           | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                           | selectattr('state','eq', state_open) 
                           | list }}
                      doors_open_count: "{{ doors_open_list | length }}"
                  # V√©rifier au moins une porte toujours ouverte
                  - condition: template
                    value_template: "{{ doors_open_count | int > 0 }}"
                  
                  # Mettre √† jour capteur statut portes
                  - if:
                      - condition: template
                        value_template: "{{ door_sensor != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ door_sensor }}"
                        data:
                          value: "{{ doors_open_count }} porte(s) ouverte(s)"
                  
                  # Appliquer mode OUVERT selon type module
                  - choose:
                      # MODULE NODON
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'NodOn' }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "{{ open_mode_mapped }}"
                    # MODULE Z-WAVE
                    default:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ open_mode == 'off' }}"
                            sequence:
                              - service: climate.turn_off
                                target:
                                  entity_id: "{{ heating_entity }}"
                        default:
                          - service: climate.set_preset_mode
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              preset_mode: "{{ open_mode }}"
                  
                  # Logger action
                  - if:
                      - condition: template
                        value_template: "{{ log_ent != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ log_ent }}"
                        data:
                          value: >
                            {{ now().strftime('%H:%M') }} - {{ room }}: Porte ouverte (>{{ door_delay.minutes | default(4) }}min) - Chauffage {{ '√âTEINT' if open_mode == 'off' else 'mode ' + open_mode }}
                  
                  # Envoyer notification
                  - if:
                      - condition: template
                        value_template: "{{ notify_devs | length > 0 }}"
                    then:
                      - repeat:
                          for_each: "{{ notify_devs }}"
                          sequence:
                            - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                              continue_on_error: true
                              data:
                                message: >
                                  üö™ {{ room }}: Porte ouverte - Chauffage {{ '√©teint' if open_mode == 'off' else 'r√©duit (' + open_mode + ')' }}
                                title: "Chauffage d√©sactiv√©"

              # Toutes les portes ferm√©es ‚Üí Restaurer mode
              - conditions:
                  - condition: template
                    value_template: >
                      {{ expand(doors) 
                         | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                         | selectattr('state','eq', state_open) 
                         | list | length == 0 }}
                sequence:
                  # Attendre dur√©e minimale fermeture
                  - delay: !input min_closed_duration
                  # V√©rifier automation toujours Active
                  - condition: template
                    value_template: "{{ status == 'Active' }}"
                  # Optimisation - Calculer une seule fois
                  - variables:
                      all_sensors_open_list: >
                        {{ expand(all_sensors) 
                           | rejectattr('state', 'in', ['unavailable', 'unknown']) 
                           | selectattr('state','eq', state_open) 
                           | list }}
                      any_sensor_open: "{{ all_sensors_open_list | length > 0 }}"
                  # V√©rifier TOUS les capteurs ferm√©s
                  - condition: template
                    value_template: "{{ not any_sensor_open }}"
                  
                  # Mettre √† jour capteur statut portes
                  - if:
                      - condition: template
                        value_template: "{{ door_sensor != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ door_sensor }}"
                        data:
                          value: "Toutes les portes ferm√©es"
                  
                  # Recalculer preset actuel avant restauration
                  - variables:
                      current_preset_now: >
                        {% if module_type == 'NodOn' %}
                          {{ states(heating_entity) }}
                        {% else %}
                          {{ state_attr(heating_entity, 'preset_mode') }}
                        {% endif %}
                      restore_mode: >
                        {% if smart_mode and current_preset_now not in [none, 'none', 'unavailable', 'unknown', ''] %}
                          {{ current_preset_now }}
                        {% else %}
                          {{ closed_mode if module_type == 'Z-Wave' else closed_mode_mapped }}
                        {% endif %}
                  
                  # Appliquer mode restauration selon type module
                  - choose:
                      # MODULE NODON
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'NodOn' }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "{{ restore_mode }}"
                    # MODULE Z-WAVE
                    default:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ restore_mode == 'off' }}"
                            sequence:
                              - service: climate.turn_off
                                target:
                                  entity_id: "{{ heating_entity }}"
                        default:
                          - service: climate.turn_on
                            target:
                              entity_id: "{{ heating_entity }}"
                          - service: climate.set_preset_mode
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              preset_mode: "{{ restore_mode }}"
                  
                  # Logger action
                  - if:
                      - condition: template
                        value_template: "{{ log_ent != '' }}"
                    then:
                      - service: input_text.set_value
                        target:
                          entity_id: "{{ log_ent }}"
                        data:
                          value: >
                            {{ now().strftime('%H:%M') }} - {{ room }}: Tout ferm√© - Chauffage {{ 'ALLUM√â' if restore_mode != 'off' else '√âTEINT' }} ({{ restore_mode }})
                  
                  # Envoyer notification
                  - if:
                      - condition: template
                        value_template: "{{ notify_devs | length > 0 }}"
                    then:
                      - repeat:
                          for_each: "{{ notify_devs }}"
                          sequence:
                            - service: notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}
                              continue_on_error: true
                              data:
                                message: >
                                  ‚úÖ {{ room }}: Tout ferm√© - Chauffage {{ 'rallum√©' if restore_mode != 'off' else '√©teint' }} ({{ restore_mode }})
                                title: "Chauffage restaur√©"
    default: []

mode: single
